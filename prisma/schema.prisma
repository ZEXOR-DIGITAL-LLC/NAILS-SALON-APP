generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  // No url or directUrl - these are now in prisma.config.ts
}

model Salon {
  id                String    @id @default(cuid())
  firstName         String
  lastName          String
  email             String    @unique
  password          String
  businessName      String
  businessImage     String?   // URL to business image stored in R2
  type              String
  otherType         String?
  waitingAmenities  String[]  // JSON array of amenities
  otherAmenity      String?
  country           String
  city              String
  address           String
  phoneNumber       String
  phoneCode         String
  termsAccepted     Boolean
  pin               String?   // 6-digit PIN for confirmation
  confirmed         Boolean   @default(false)
  resetPin          String?   // 6-digit PIN for password reset
  resetPinExpiry    DateTime? // Expiry time for reset PIN
  revenuePin        String?   // 4-digit PIN for revenue page access

  // Subscription Tracking
  subscriptionStatus    String    @default("none")  // 'none' | 'trial' | 'paid' | 'promo' | 'expired'
  subscriptionStartDate DateTime? // When the current subscription period started
  subscriptionExpiresAt DateTime? // When the current access expires
  promoCodeUsed         String?   // The promo code used (if status is 'promo')

  // Business Hours
  isOpen            Boolean   @default(true)      // Open/Closed toggle for bookings
  workingDays       Int[]     @default([1, 2, 3, 4, 5, 6]) // Days of week: 0=Sun, 1=Mon, ..., 6=Sat
  openingHour       Int       @default(9)         // Opening hour (0-23)
  openingMinute     Int       @default(0)         // Opening minute (0-59)
  closingHour       Int       @default(18)        // Closing hour (0-23)
  closingMinute     Int       @default(0)         // Closing minute (0-59)

  // Push Notifications
  pushToken         String?   // Expo Push Token for booking notifications

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  appointments           OwnerAppointment[]
  galleries              Gallery[]
  galleryImages          GalleryImage[]
  employees              Employee[]
  salonClients           SalonClient[]
  products               Product[]
  productCategories      ProductCategory[]
  productHistories       ProductHistory[]
  notificationSettings   NotificationSettings?
  inventoryNotifications InventoryNotification[]
}

model Client {
  id                String    @id @default(cuid())
  firstName         String
  lastName          String
  email             String    @unique
  password          String
  country           String
  city              String
  address           String
  phoneNumber       String
  phoneCode         String
  termsAccepted     Boolean
  pin               String?   // 6-digit PIN for confirmation
  confirmed         Boolean   @default(false)
  resetPin          String?   // 6-digit PIN for password reset
  resetPinExpiry    DateTime? // Expiry time for reset PIN
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model OwnerAppointment {
  id                String    @id @default(cuid())
  salonId           String    // Links to Salon owner - isolates data by user
  employeeId        String?   // Optional: Assigned employee (null = unassigned)
  salonClientId     String?   // Optional: Linked salon client profile
  clientName        String    // Name of the client for the appointment
  service           String    // Service description
  appointmentDate   DateTime  // Date of the appointment
  appointmentHour   Int       // Hour (0-23)
  appointmentMinute Int       // Minute (0-59)
  durationHours     Int       @default(1)
  durationMinutes   Int       @default(0)
  status            String    @default("Pending") // Pending, Completed, Canceled
  amount            Float?    // Earnings amount in dollars (null until set by salon owner)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  salon             Salon         @relation(fields: [salonId], references: [id], onDelete: Cascade)
  employee          Employee?     @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  salonClient       SalonClient?  @relation(fields: [salonClientId], references: [id], onDelete: SetNull)

  @@index([salonId])
  @@index([salonId, appointmentDate])
  @@index([employeeId])
  @@index([salonId, employeeId])
  @@index([salonClientId])
}

model Gallery {
  id          String         @id @default(cuid())
  salonId     String
  title       String
  description String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  salon       Salon          @relation(fields: [salonId], references: [id], onDelete: Cascade)
  images      GalleryImage[]

  @@index([salonId])
}

model GalleryImage {
  id        String   @id @default(cuid())
  galleryId String
  salonId   String
  imageUrl  String
  order     Int      @default(0)
  createdAt DateTime @default(now())

  gallery   Gallery  @relation(fields: [galleryId], references: [id], onDelete: Cascade)
  salon     Salon    @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@index([galleryId])
  @@index([salonId])
}

model Employee {
  id          String    @id @default(cuid())
  salonId     String    // Links to Salon owner
  name        String    // Employee display name
  isActive    Boolean   @default(true) // Active/Inactive toggle
  color       String?   // Hex color for UI differentiation (e.g., "#FF5733")
  specialties String[]  // Array of service specialties
  order       Int       @default(0) // Display order in lists
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  salon        Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)
  appointments OwnerAppointment[]

  @@index([salonId])
  @@index([salonId, isActive])
}

model SalonClient {
  id          String    @id @default(cuid())
  salonId     String
  clientCode  String?   // Unique per salon: CLT-0001, CLT-0002, etc.
  firstName   String
  lastName    String    @default("")
  phone       String?
  email       String?
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  salon        Salon              @relation(fields: [salonId], references: [id], onDelete: Cascade)
  appointments OwnerAppointment[]

  @@unique([salonId, clientCode])
  @@index([salonId])
  @@index([salonId, firstName, lastName])
}

model ProductCategory {
  id          String    @id @default(cuid())
  salonId     String
  name        String
  description String?
  order       Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  salon       Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)
  products    Product[]

  @@index([salonId])
}

model Product {
  id              String    @id @default(cuid())
  salonId         String
  categoryId      String?
  name            String
  description     String?
  sku             String?
  currentStock    Int       @default(0)
  reorderPoint    Int       @default(5)
  criticalPoint   Int       @default(2)
  unitCost        Float?
  supplier        String?
  expirationDate  DateTime?
  isExpired       Boolean   @default(false)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  salon           Salon           @relation(fields: [salonId], references: [id], onDelete: Cascade)
  category        ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  history         ProductHistory[]
  notifications   InventoryNotification[]

  @@index([salonId])
  @@index([salonId, categoryId])
  @@index([salonId, isActive])
}

model ProductHistory {
  id            String    @id @default(cuid())
  productId     String
  salonId       String
  action        String
  previousStock Int?
  newStock      Int?
  quantity      Int?
  notes         String?
  createdAt     DateTime  @default(now())

  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  salon         Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([productId, createdAt])
  @@index([salonId])
}

model NotificationSettings {
  id                          String    @id @default(cuid())
  salonId                     String    @unique
  bookingNotificationsEnabled Boolean   @default(false)
  inventoryExpirationEnabled  Boolean   @default(false)
  daysBeforeExpiration        Int       @default(7)
  lowStockEnabled             Boolean   @default(false)
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt

  salon                       Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@index([salonId])
}

model InventoryNotification {
  id          String    @id @default(cuid())
  salonId     String
  productId   String
  productName String
  type        String    // 'expiring' | 'expired' | 'low_stock' | 'critical_stock'
  message     String
  isRead      Boolean   @default(false)
  isArchived  Boolean   @default(false)
  expiresAt   DateTime? // The actual expiration date of the product (null for stock notifications)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  salon       Salon     @relation(fields: [salonId], references: [id], onDelete: Cascade)
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([salonId])
  @@index([salonId, isRead])
  @@index([salonId, isArchived])
  @@index([productId])
}

model PromoCode {
  id          String    @id @default(cuid())
  code        String    @unique  // 6-character uppercase code
  usedByEmail String?   // Email of the user who redeemed it
  salonId     String?   // Salon ID linked to the redemption
  usedAt      DateTime? // When the code was first used (start of 30-day access)
  expiresAt   DateTime? // When the 30-day access expires
  isUsed      Boolean   @default(false)
  createdAt   DateTime  @default(now())

  @@index([code])
  @@index([usedByEmail])
  @@index([salonId])
}